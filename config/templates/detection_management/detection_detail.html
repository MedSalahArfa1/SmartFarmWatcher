{% extends "dashboard/dashboard_base.html" %}

{% block title %}Detection #{{ detection.id }} - Detection Details{% endblock %}

{% block nav_detections_history %}active{% endblock %}

{% block extra_css %}
<style>
.main-container {
    padding: 30px 0;
}

.detection-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
}

.detection-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.2rem;
    font-weight: 600;
}

.detection-meta {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-top: 15px;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    opacity: 0.9;
    color: white;
    font-size: 14px;
}

.meta-item i {
    width: 16px;
    text-align: center;
}

/* Updated KPI Cards - Dashboard Style */
.info-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.info-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: none;
    transition: all 0.3s ease;
    height: 100%;
    position: relative;
    overflow: hidden;
}

/* Specific stat card styling for each metric */
.info-card.fire::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #ff5722, #e64a19);
}

.info-card.person::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #2196F3, #1976D2);
}

.info-card.smoke::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #9E9E9E, #757575);
}

.info-card.confidence::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, var(--success-color), #1e7e34);
}

.info-card.camera::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, var(--warning-color), #e0a800);
}

.info-card.objects::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, var(--info-color), #138496);
}

.info-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
}

.stat-icon {
    width: 65px;
    height: 65px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 26px;
    color: white;
    margin-bottom: 20px;
}

.stat-icon.fire { background: linear-gradient(135deg, #ff5722, #e64a19); }
.stat-icon.person { background: linear-gradient(135deg, #2196F3, #1976D2); }
.stat-icon.smoke { background: linear-gradient(135deg, #9E9E9E, #757575); }
.stat-icon.confidence { background: linear-gradient(135deg, var(--success-color), #1e7e34); }
.stat-icon.camera { background: linear-gradient(135deg, var(--warning-color), #e0a800); }
.stat-icon.objects { background: linear-gradient(135deg, var(--info-color), #138496); }

.stat-number {
    font-size: 2.8rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 0;
    line-height: 1;
}

.stat-label {
    color: #6c757d;
    font-size: 14px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 8px;
}

/* Special styling for percentage and ID displays */
.stat-percentage {
    font-size: 2.2rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 0;
    line-height: 1;
}

.stat-id {
    font-size: 2.4rem;
    font-weight: 700;
    color: #2c3e50;
    margin: 0;
    line-height: 1;
}

.detection-image-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 30px;
    position: relative;
    z-index: 10;
}

.image-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
}

.image-header h3 {
    margin: 0;
    color: #2c3e50;
}

.detection-image {
    width: 100%;
    height: auto;
    max-height: 600px;
    object-fit: contain;
    display: block;
}

.detection-image-container {
    position: relative;
    display: inline-block;
    width: 100%;
}

.confidence-overlay {
    position: absolute;
    bottom: 20px;
    left: 20px;
    right: 20px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 12px;
    padding: 15px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.confidence-overlay-header {
    color: white;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.confidence-overlay .confidence-bar {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    overflow: hidden;
    margin: 0;
}

.detection-badge {
    padding: 8px 16px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 500;
    color: white;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.detection-badge.fire {
    background: #ff5722;
}

.detection-badge.person {
    background: #2196F3;
}

.detection-badge.smoke {
    background: #9E9E9E;
}

.confidence-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin: 15px 0;
}

.confidence-bar {
    width: 100%;
    height: 12px;
    background: #e9ecef;
    border-radius: 6px;
    overflow: hidden;
    margin: 10px 0;
}

.confidence-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.confidence-fill.fire {
    background: #ff5722;
}

.confidence-fill.person {
    background: #2196F3;
}

.confidence-fill.smoke {
    background: #9E9E9E;
}

/* NEW: Side by side layout for map and details */
.map-details-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
    align-items: stretch;
}

.map-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    position: relative;
    z-index: 10;
    display: flex;
    flex-direction: column;
    height: 580px;
}

.map-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    background: #f8f9fa;
    flex-shrink: 0;
}

.map-header h3 {
    margin: 0;
    color: #2c3e50;
}

/* Map container styling */
#detection-map {
    flex: 1;
    min-height: 400px;
    width: 100% !important;
    position: relative;
    z-index: -1;
    background: #f8f9fa;
}

/* Camera marker styling */
.camera-marker {
    background: none !important;
    border: none !important;
}

/* Leaflet controls */
.leaflet-control-container {
    position: relative;
    z-index: 1000;
}

.leaflet-tile-pane {
    z-index: 200;
}

.leaflet-overlay-pane {
    z-index: 400;
}

.leaflet-shadow-pane {
    z-index: 500;
}

.leaflet-marker-pane {
    z-index: 600;
}

.leaflet-tooltip-pane {
    z-index: 650;
}

.leaflet-popup-pane {
    z-index: 700;
}

.details-section {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 10;
    height: 580px;
    display: flex;
    flex-direction: column;
}

.details-content {
    flex: 1;
    overflow-y: auto;
}

.details-header {
    margin-bottom: 20px;
    flex-shrink: 0;
}

/* ADD THIS CSS TO YOUR STYLESHEET - Missing Button Styles */

/* Action Button General Styling */
.action-buttons .btn {
    flex: 1;
    padding: 12px 20px;
    font-weight: 600;
    border-radius: 8px;
    transition: all 0.3s ease;
    border-width: 2px !important;
}

/* Toggle Button - Warning State (Orange) */
.toggle-false-positive.btn-outline-warning {
    border-color: #ffc107 !important;
    color: #ffc107 !important;
    background: white !important;
}

.toggle-false-positive.btn-outline-warning:hover,
.toggle-false-positive.btn-outline-warning:focus,
.toggle-false-positive.btn-outline-warning:active {
    background: #ffc107 !important;
    border-color: #ffc107 !important;
    color: #212529 !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25) !important;
}

/* Toggle Button - Success State (Green) */
.toggle-false-positive.btn-outline-success {
    border-color: #28a745 !important;
    color: #28a745 !important;
    background: white !important;
}

.toggle-false-positive.btn-outline-success:hover,
.toggle-false-positive.btn-outline-success:focus,
.toggle-false-positive.btn-outline-success:active {
    background: #28a745 !important;
    border-color: #28a745 !important;
    color: white !important;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
}

/* Disabled state for buttons */
.btn:disabled {
    opacity: 0.6 !important;
    cursor: not-allowed !important;
}



.detail-group {
    margin-bottom: 20px;
}

.detail-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.detail-label i {
    color: var(--primary-color);
    width: 16px;
}

.detail-value {
    color: #6c757d;
    line-height: 1.6;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(255, 255, 255, 0.15);
    padding: 8px 16px;
    border-radius: 25px;
    color: white !important;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 15px;
}

.back-link:hover {
    background: rgba(255, 255, 255, 0.25);
    color: white !important;
    transform: translateX(-3px);
    border-color: rgba(255, 255, 255, 0.3);
}

.back-link i {
    transition: transform 0.3s ease;
}

.back-link:hover i {
    transform: translateX(-2px);
}

.confidence-indicator {
    background: rgba(255, 255, 255, 0.15);
    padding: 6px 12px;
    border-radius: 20px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.detection-status-badge {
    background: white !important;
    color: var(--success-color) !important;
    border: 2px solid var(--success-color) !important;
    padding: 8px 16px !important;
    border-radius: 25px !important;
    font-weight: 600 !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
}

.detection-status-badge.false-positive {
    background: white !important;
    color: var(--warning-color) !important;
    border: 2px solid var(--warning-color) !important;
}

.detection-status-badge.valid {
    background: white !important;
    color: #28a745 !important;
    border: 2px solid #28a745 !important;
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin-top: auto;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
    flex-shrink: 0;
}

.btn-outline-warning.active {
    background: var(--warning-color);
    border-color: var(--warning-color);
    color: white;
}

.status-badge {
    padding: 8px 15px;
    border-radius: 25px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.status-false-positive {
    background: #fff3cd;
    color: #856404;
}

@media (max-width: 1200px) {
    .map-details-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .map-section, .details-section {
        height: auto;
    }
    
    #detection-map {
        height: 400px !important;
        min-height: 400px;
    }
}

@media (max-width: 768px) {
    .detection-meta {
        flex-direction: column;
        gap: 10px;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 20px;
    }
    
    .confidence-indicator {
        font-size: 12px;
        padding: 5px 10px;
    }
    
    .info-cards {
        grid-template-columns: 1fr;
    }
    
    .map-details-container {
        grid-template-columns: 1fr;
    }
    
    .map-section, .details-section {
        height: auto;
    }
    
    #detection-map {
        height: 350px !important;
        min-height: 350px;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .confidence-overlay {
        bottom: 10px;
        left: 10px;
        right: 10px;
        padding: 10px;
    }
    
    .confidence-overlay-header {
        font-size: 12px;
    }
}

/* Detection Details Table Styling */
.detail-table {
    margin-bottom: 0;
}

.detail-table td {
    padding: 12px 15px;
    border: none;
    vertical-align: middle;
}

.table-section-header td {
    padding-top: 20px !important;
    padding-bottom: 10px !important;
    border-bottom: 1px solid #e9ecef !important;
}

.table-section-header:first-child td {
    padding-top: 0 !important;
}

.detail-label-table {
    width: 40%;
    font-weight: 600;
    color: #495057;
    background: #f8f9fa;
    border-right: 1px solid #e9ecef;
    font-size: 14px;
}

.detail-value-table {
    width: 60%;
    color: #6c757d;
    background: white;
    font-size: 14px;
}

/* Mini confidence bar for table */
.confidence-bar-mini {
    width: 100px;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    display: inline-block;
}

.confidence-bar-mini .confidence-fill {
    height: 100%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

/* Table responsive improvements */
@media (max-width: 768px) {
    .detail-label-table,
    .detail-value-table {
        width: 100%;
        display: block;
        padding: 8px 15px;
    }
    
    .detail-label-table {
        background: #f8f9fa;
        border-right: none;
        border-bottom: 1px solid #e9ecef;
        font-weight: 700;
        padding-bottom: 5px;
    }
    
    .detail-value-table {
        background: white;
        padding-top: 5px;
        padding-bottom: 15px;
    }
    
    .table-section-header td {
        padding-top: 15px !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="detection-header">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <a href="{% url 'detection_management:detection_history' %}" class="back-link">
                <i class="fas fa-arrow-left"></i> Back to Detections History
            </a>
            <h1>Detection #{{ detection.id }}</h1>
            
            <!-- Meta information in project style -->
            <div class="detection-meta">
                
                <div class="meta-item">
                    <i class="fas fa-project-diagram"></i>
                    <span>{{ detection.camera.project.name }}</span>
                </div>
                {% if detection.camera.farm_boundary %}
                <div class="meta-item">
                    <i class="fas fa-vector-square"></i>
                    <span>Farm Boundary #{{ detection.camera.farm_boundary.id }}</span>
                </div>
                {% endif %}
                <div class="meta-item">
                    <i class="fas fa-video"></i>
                    <span>Camera #{{ detection.camera.id }}</span>
                </div>
            </div>
        </div>
        <div>
            <span class="detection-status-badge {% if detection.is_false_positive %}false-positive{% else %}valid{% endif %}">
                {% if detection.is_false_positive %}
                    <i class="fas fa-flag"></i> False Positive
                {% else %}
                    <i class="fas fa-check-circle"></i> Valid Detection
                {% endif %}
            </span>
        </div>
    </div>
</div>

<!-- Statistics Cards with Dashboard Style -->
<div class="info-cards">
    <div class="info-card {{ detection.detection_type.name }}">
        <div class="stat-icon {{ detection.detection_type.name }}">
            {% if detection.detection_type.name == 'fire' %}
                <i class="fas fa-fire"></i>
            {% elif detection.detection_type.name == 'person' %}
                <i class="fas fa-user"></i>
            {% elif detection.detection_type.name == 'smoke' %}
                <i class="fas fa-smog"></i>
            {% endif %}
        </div>
        <h3 class="stat-number">{{ detection.detection_type.name|capfirst }}</h3>
        <p class="stat-label">Detection Type</p>
    </div>
    <div class="info-card confidence">
        <div class="stat-icon confidence">
            <i class="fas fa-chart-line"></i>
        </div>
        <h3 class="stat-number">{{ detection.confidence_percentage|floatformat:1 }}%</h3>
        <p class="stat-label">Confidence Level</p>
    </div>
    <div class="info-card camera">
        <div class="stat-icon camera">
            <i class="fas fa-calendar"></i>
        </div>
        <h3 class="stat-number">{{ detection.detected_at|date:"M d" }}</h3>
        <p class="stat-label">Detection Date</p>
    </div>
    <div class="info-card objects">
        <div class="stat-icon objects">
            <i class="fas fa-clock"></i>
        </div>
        <h3 class="stat-number">{{ detection.detected_at|date:"H:i:s" }}</h3>
        <p class="stat-label">Detection Time</p>
    </div>
</div>

<!-- Detection Image -->
{% if detection.image_annotated %}
<div class="detection-image-section">
    <div class="image-header">
        <div class="d-flex justify-content-between align-items-center">
            <h4 style="color: var(--primary-color);"><i class="fas fa-image"></i> Detection Image</h4>
            <div class="d-flex gap-2">
                {% if detection.image_original %}
                <a href="{{ detection.image_original.url }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-download"></i> Original Image
                </a>
                {% endif %}
                <a href="{{ detection.image_annotated.url }}" target="_blank" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-external-link-alt"></i> Full Size
                </a>
            </div>
        </div>
        
    </div>
    <div class="text-center">
        <div class="detection-image-container">
            <img src="{{ detection.image_annotated.url }}" 
                 alt="Detection #{{ detection.id }}" 
                 class="detection-image">
        </div>
    </div>
</div>
{% endif %}

<!-- NEW: Side by side container for map and details -->
<div class="map-details-container">
    <!-- Camera Location Map -->
    <div class="map-section">
        <div class="map-header">
            <h4 style="color: var(--primary-color);"><i class="fas fa-map"></i> Camera Location & Project Boundaries</h4>
            <p class="mb-0 text-muted">
                <span class="badge bg-success me-2">Green Areas</span> Farm Boundaries<br>
                <span class="badge bg-danger me-2">Red Marker</span> Detection Camera Location<br>
                <span class="badge bg-primary me-2">Blue Markers</span> Other Project Cameras
            </p>
        </div>
        <div id="detection-map"></div>
    </div>

    <!-- Detection Details -->
    <div class="details-section">
        <div class="details-header">
            <h4 style="color: var(--primary-color);"><i class="fas fa-info-circle"></i> Detection Details</h4>
        </div>
        
        <!-- Detection Details Section - Replace the existing details-content div -->
<div class="details-content">
    <div class="table-responsive">
        <table class="table table-borderless detail-table">
            <tbody>
                <!-- Detection Information -->
                <tr class="table-section-header">
                    <td colspan="2">
                        <h5 class="mb-0">
                            <i class="fas fa-bullseye me-2"></i>Detection Information
                        </h5>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-hashtag text-muted me-2"></i>Detection ID
                    </td>
                    <td class="detail-value-table">
                        <span class="badge bg-light text-dark">#{{ detection.id }}</span>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-fire text-muted me-2"></i>Detection Type
                    </td>
                    <td class="detail-value-table">
                        <span class="detection-badge {{ detection.detection_type.name }}">
                            {% if detection.detection_type.name == 'fire' %}
                                <i class="fas fa-fire"></i>
                            {% elif detection.detection_type.name == 'person' %}
                                <i class="fas fa-user"></i>
                            {% elif detection.detection_type.name == 'smoke' %}
                                <i class="fas fa-smog"></i>
                            {% endif %}
                            {{ detection.detection_type.name|capfirst }}
                        </span>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-percentage text-muted me-2"></i>Confidence Score
                    </td>
                    <td class="detail-value-table">
                        <div class="d-flex align-items-center">
                            <span class="fw-bold me-2">{{ detection.confidence_percentage|floatformat:2 }}%</span>
                            <div class="confidence-bar-mini">
                                <div class="confidence-fill {{ detection.detection_type.name }}" 
                                     style="width: {{ detection.confidence_percentage }}%;"></div>
                            </div>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-clock text-muted me-2"></i>Detection Date & Time
                    </td>
                    <td class="detail-value-table">
                        <div>
                            <strong>{{ detection.detected_at|date:"F d, Y" }}</strong><br>
                            <small class="text-muted">{{ detection.detected_at|date:"H:i:s" }} ({{ detection.detected_at|timesince }} ago)</small>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-flag text-muted me-2"></i>Status
                    </td>
                    <td class="detail-value-table">
                        <span class="detection-status-badge {% if detection.is_false_positive %}false-positive{% else %}valid{% endif %}">
                            {% if detection.is_false_positive %}
                                <i class="fas fa-flag"></i> False Positive
                            {% else %}
                                <i class="fas fa-check-circle"></i> Valid Detection
                            {% endif %}
                        </span>
                    </td>
                </tr>

                <!-- Spacing row -->
                <tr><td colspan="2" class="pb-3"></td></tr>

                <!-- Camera Information -->
                <tr class="table-section-header">
                    <td colspan="2">
                        <h5 class="mb-0">
                            <i class="fas fa-video me-2"></i>Camera Information
                        </h5>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-camera text-muted me-2"></i>Camera ID
                    </td>
                    <td class="detail-value-table">
                        <span class="badge bg-light text-dark">#{{ detection.camera.id }}</span>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-cog text-muted me-2"></i>Camera Type
                    </td>
                    <td class="detail-value-table">
                        <span class="badge bg-secondary">{{ detection.camera.get_camera_type_display }}</span>
                    </td>
                </tr>
                {% if detection.camera.get_connection_string %}
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-link text-muted me-2"></i>Connection
                    </td>
                    <td class="detail-value-table">
                        <code class="bg-light p-1 rounded">{{ detection.camera.get_connection_string }}</code>
                    </td>
                </tr>
                {% endif %}
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-map-marker-alt text-muted me-2"></i>Location Status
                    </td>
                    <td class="detail-value-table">
                        <span class="badge {% if detection.camera.is_within_farm_boundary %}bg-success{% else %}bg-warning{% endif %}">
                            {% if detection.camera.is_within_farm_boundary %}
                                <i class="fas fa-check"></i> Inside Boundary
                            {% else %}
                                <i class="fas fa-exclamation-triangle"></i> Outside Boundary
                            {% endif %}
                        </span>
                    </td>
                </tr>

                {% if detection.camera.farm_boundary %}
                <!-- Spacing row -->
                <tr><td colspan="2" class="pb-3"></td></tr>

                <!-- Farm Boundary Information (moved before Project) -->
                <tr class="table-section-header">
                    <td colspan="2">
                        <h5 class="mb-0">
                            <i class="fas fa-vector-square me-2"></i>Farm Boundary Information
                        </h5>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-hashtag text-muted me-2"></i>Boundary ID
                    </td>
                    <td class="detail-value-table">
                        <span class="badge bg-light text-dark">#{{ detection.camera.farm_boundary.id }}</span>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-ruler-combined text-muted me-2"></i>Area
                    </td>
                    <td class="detail-value-table">
                        <strong>{{ detection.camera.farm_boundary.area_hectares|floatformat:2 }} hectares</strong>
                    </td>
                </tr>
                {% if detection.camera.farm_boundary.description %}
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-info-circle text-muted me-2"></i>Description
                    </td>
                    <td class="detail-value-table">
                        {{ detection.camera.farm_boundary.description }}
                    </td>
                </tr>
                {% endif %}
                {% endif %}

                <!-- Spacing row -->
                <tr><td colspan="2" class="pb-3"></td></tr>

                <!-- Project Information (moved after Farm Boundary) -->
                <tr class="table-section-header">
                    <td colspan="2">
                        <h5 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>Project Information
                        </h5>
                    </td>
                </tr>
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-folder text-muted me-2"></i>Project Name
                    </td>
                    <td class="detail-value-table">
                        <strong>{{ detection.camera.project.name }}</strong>
                    </td>
                </tr>
                {% if detection.camera.project.location_city %}
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-map-marker-alt text-muted me-2"></i>Location
                    </td>
                    <td class="detail-value-table">
                        {{ detection.camera.project.location_city }}
                    </td>
                </tr>
                {% endif %}
                <tr>
                    <td class="detail-label-table">
                        <i class="fas fa-calendar-plus text-muted me-2"></i>Project Created
                    </td>
                    <td class="detail-value-table">
                        {{ detection.camera.project.created_at|date:"M d, Y" }}
                        <small class="text-muted">({{ detection.camera.project.created_at|timesince }} ago)</small>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
        
       <div class="action-buttons">
    <button class="btn toggle-false-positive" 
            data-detection-id="{{ detection.id }}"
            data-is-false="{{ detection.is_false_positive }}">
        <!-- Button content will be set by JavaScript -->
    </button>
    <a href="{% url 'detection_management:camera_detections' detection.camera.id %}" 
       class="btn btn-outline-primary">
        <i class="fas fa-video"></i> View All Camera Detections
    </a>
</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('=== DETECTION MAP INITIALIZATION ===');

let detectionMap;

// Get data from Django with safe parsing
let boundariesData, camerasData, detectionCamera, mapCenter;

try {
    boundariesData = {{ boundaries_data|safe }} || [];
    camerasData = {{ cameras_data|safe }} || [];
    detectionCamera = {{ detection_camera_data|safe }} || null;
    mapCenter = {{ map_center|safe }} || [36.8065, 10.1815];
} catch (e) {
    console.error('Error parsing Django data:', e);
    boundariesData = [];
    camerasData = [];
    detectionCamera = null;
    mapCenter = [36.8065, 10.1815];
}

console.log('Parsed data:');
console.log('- Boundaries:', boundariesData);
console.log('- Cameras:', camerasData);
console.log('- Detection Camera:', detectionCamera);
console.log('- Map Center:', mapCenter);

// Camera icon function
function getCameraIcon(isDetectionCamera = false, isInside = true) {
    let backgroundColor;
    if (isDetectionCamera) {
        backgroundColor = '#dc3545'; // Red for detection camera
    } else if (isInside) {
        backgroundColor = '#2196F3'; // Blue for cameras inside boundary
    } else {
        backgroundColor = '#ff9800'; // Orange for cameras outside boundary
    }

    return L.divIcon({
        className: 'camera-marker',
        html: `<div style="
            background: ${backgroundColor};
            width: ${isDetectionCamera ? 24 : 20}px;
            height: ${isDetectionCamera ? 24 : 20}px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: ${isDetectionCamera ? 12 : 10}px;
        "><i class="fas fa-video"></i></div>`,
        iconSize: [isDetectionCamera ? 30 : 26, isDetectionCamera ? 30 : 26],
        iconAnchor: [isDetectionCamera ? 15 : 13, isDetectionCamera ? 15 : 13]
    });
}

// Wait for everything to load
window.addEventListener('load', function() {
    console.log('Window loaded, initializing detection map...');
    setTimeout(function() {
        initializeDetectionMap();
    }, 1000);
});

function initializeDetectionMap() {
    try {
        console.log('Starting detection map initialization...');
        
        // Check container
        const container = document.getElementById('detection-map');
        if (!container) {
            console.error('❌ Map container not found!');
            return;
        }
        console.log('✅ Map container found');
        
        // Check Leaflet
        if (typeof L === 'undefined') {
            console.error('❌ Leaflet not loaded!');
            return;
        }
        console.log('✅ Leaflet loaded');
        
        // Use detection camera position as center if available
        let center = [36.8065, 10.1815]; // Tunis default
        if (detectionCamera && !isNaN(detectionCamera.latitude) && !isNaN(detectionCamera.longitude)) {
            center = [detectionCamera.latitude, detectionCamera.longitude];
        } else if (mapCenter && Array.isArray(mapCenter) && mapCenter.length === 2 && 
                   !isNaN(mapCenter[0]) && !isNaN(mapCenter[1])) {
            center = mapCenter;
        }
        console.log('✅ Using center:', center);
        
        // Create map
        detectionMap = L.map('detection-map').setView(center, 15);
        console.log('✅ Map object created');
        
        // Add satellite tile layer
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        }).addTo(detectionMap);
        console.log('✅ Satellite tile layer added');
        
        // Force resize
        setTimeout(function() {
            detectionMap.invalidateSize();
            console.log('✅ Map size invalidated');
        }, 100);
        
        console.log('✅ Basic detection map initialized successfully');
        
        // Add farm boundaries
        if (boundariesData && Array.isArray(boundariesData) && boundariesData.length > 0) {
            console.log('Adding farm boundaries...');
            const boundaryLayers = [];
            
            boundariesData.forEach(function(boundary, index) {
                try {
                    if (boundary && boundary.geometry) {
                        const boundaryLayer = L.geoJSON(boundary.geometry, {
                            style: {
                                color: '#4CAF50',
                                weight: 3,
                                fillOpacity: 0.2,
                                fillColor: '#4CAF50'
                            }
                        }).addTo(detectionMap);
                        
                        boundaryLayers.push(boundaryLayer);
                        
                        const popupContent = 
                            '<div style="text-align: center;">' +
                            '<h6>Farm Boundary #' + (boundary.id || index + 1) + '</h6>' +
                            '<p><strong>Area:</strong> ' + (boundary.area_hectares || 'N/A') + ' hectares</p>' +
                            (boundary.description ? '<p><strong>Description:</strong> ' + boundary.description + '</p>' : '') +
                            '</div>';
                        
                        boundaryLayer.bindPopup(popupContent);
                        console.log('✅ Added boundary #' + (boundary.id || index + 1));
                    }
                } catch (e) {
                    console.error('❌ Error loading boundary:', e);
                }
            });
        }
        
        // Add detection camera marker (highlighted)
        if (detectionCamera && !isNaN(detectionCamera.latitude) && !isNaN(detectionCamera.longitude)) {
            console.log('Adding detection camera marker...');
            const detectionIcon = getCameraIcon(true, detectionCamera.is_within_boundary);
            
            const detectionMarker = L.marker([detectionCamera.latitude, detectionCamera.longitude], {
                icon: detectionIcon
            }).addTo(detectionMap);
            
            let connectionInfo = '';
            if (detectionCamera.camera_type === 'ip') {
                connectionInfo = `${detectionCamera.ip_address || ''}:${detectionCamera.port || ''}`;
            } else if (detectionCamera.camera_type === 'cellular') {
                connectionInfo = detectionCamera.cellular_identifier || '';
            }
            
            const detectionPopupContent = 
                '<div class="camera-popup">' +
                '<h6><strong>🎯 Detection Camera #' + detectionCamera.id + '</strong></h6>' +
                '<p><span class="badge bg-danger">DETECTION SOURCE</span></p>' +
                '<p><span class="badge bg-secondary">' + (detectionCamera.camera_type || 'Unknown').toUpperCase() + '</span></p>' +
                (connectionInfo ? '<p><code>' + connectionInfo + '</code></p>' : '') +
                '<p><span class="badge ' + (detectionCamera.is_within_boundary ? 'bg-success' : 'bg-warning') + '">' +
                (detectionCamera.is_within_boundary ? 'Inside Boundary' : 'Outside Boundary') + '</span></p>' +
                '<small>Farm Boundary #' + (detectionCamera.farm_boundary_id || 'N/A') + '</small>' +
                '</div>';
            
            detectionMarker.bindPopup(detectionPopupContent);
            console.log('✅ Added detection camera marker');
            
            // Center map on detection camera
            detectionMap.setView([detectionCamera.latitude, detectionCamera.longitude], 16);
        }
        
        // Add other project cameras
        if (camerasData && Array.isArray(camerasData) && camerasData.length > 0) {
            console.log('Adding other camera markers...');
            camerasData.forEach(function(camera, index) {
                try {
                    if (camera && !isNaN(camera.latitude) && !isNaN(camera.longitude)) {
                        // Skip if this is the detection camera (already added)
                        if (detectionCamera && camera.id === detectionCamera.id) {
                            return;
                        }
                        
                        const isInside = camera.is_within_boundary;
                        const cameraIcon = getCameraIcon(false, isInside);
                        
                        const marker = L.marker([camera.latitude, camera.longitude], {
                            icon: cameraIcon
                        }).addTo(detectionMap);
                        
                        let connectionInfo = '';
                        if (camera.camera_type === 'ip') {
                            connectionInfo = `${camera.ip_address || ''}:${camera.port || ''}`;
                        } else if (camera.camera_type === 'cellular') {
                            connectionInfo = camera.cellular_identifier || '';
                        }
                        
                        const popupContent = 
                            '<div class="camera-popup">' +
                            '<h6>Camera #' + camera.id + '</h6>' +
                            '<p><span class="badge bg-secondary">' + (camera.camera_type || 'Unknown').toUpperCase() + '</span></p>' +
                            (connectionInfo ? '<p><code>' + connectionInfo + '</code></p>' : '') +
                            '<p><span class="badge ' + (isInside ? 'bg-success' : 'bg-warning') + '">' +
                            (isInside ? 'Inside Boundary' : 'Outside Boundary') + '</span></p>' +
                            '<small>Farm Boundary #' + (camera.farm_boundary_id || 'N/A') + '</small>' +
                            '</div>';
                        
                        marker.bindPopup(popupContent);
                        console.log('✅ Added camera #' + camera.id);
                    }
                } catch (e) {
                    console.error('❌ Error loading camera:', e);
                }
            });
        }
        
        // Add scale control
        L.control.scale().addTo(detectionMap);
        
        // Final resize
        setTimeout(function() {
            detectionMap.invalidateSize();
            console.log('✅ Final detection map resize completed');
            console.log('=== DETECTION MAP INITIALIZATION SUCCESS ===');
        }, 500);
        
    } catch (error) {
        console.error('❌ CRITICAL ERROR:', error);
        
        const container = document.getElementById('detection-map');
        if (container) {
            container.innerHTML = 
                '<div style="height: 100%; display: flex; align-items: center; justify-content: center; background: #f8f9fa; color: #666; flex-direction: column;">' +
                '<i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #dc3545;"></i>' +
                '<h5>Map Loading Failed</h5>' +
                '<p>Check console for details</p>' +
                '<button onclick="location.reload()" class="btn btn-primary btn-sm">Reload Page</button>' +
                '</div>';
        }
    }
}

// Handle false positive toggle
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.querySelector('.toggle-false-positive');
    if (toggleBtn) {
        // Set initial button state based on detection status
        updateToggleButtonState(toggleBtn);
        
        toggleBtn.addEventListener('click', function() {
            const detectionId = this.dataset.detectionId;
            const isFalse = this.dataset.isFalse === 'true';
            
            // Disable button during request
            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
            
            fetch(`/detection/mark-false-positive/${detectionId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                  document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'),
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (typeof showToast === 'function') {
                        showToast('Detection status updated successfully', 'success');
                    }
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    // Reset button state on error
                    this.disabled = false;
                    this.innerHTML = originalText;
                    if (typeof showToast === 'function') {
                        showToast('Error updating detection status', 'error');
                    } else {
                        alert('Error updating detection status');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Reset button state on error
                this.disabled = false;
                this.innerHTML = originalText;
                if (typeof showToast === 'function') {
                    showToast('Error updating detection status', 'error');
                } else {
                    alert('Error updating detection status');
                }
            });
        });
    }

    // Add animation on load - same as dashboard
    const cards = document.querySelectorAll('.info-card');
    cards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            
            setTimeout(() => {
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }, index * 100);
    });
});

// REPLACE your updateToggleButtonState function with this CORRECTED version

function updateToggleButtonState(button) {
    console.log('🔧 updateToggleButtonState called');
    console.log('🎯 Button dataset.isFalse:', button.dataset.isFalse);
    console.log('🎯 Type of dataset.isFalse:', typeof button.dataset.isFalse);
    
    // FIX: Handle both "True"/"False" (Django) and "true"/"false" (JavaScript) 
    const isFalse = button.dataset.isFalse === 'true' || button.dataset.isFalse === 'True';
    console.log('🔍 Computed isFalse (boolean):', isFalse);
    
    // Clear ALL existing classes completely
    button.className = 'btn toggle-false-positive';
    console.log('🧹 Cleared all classes, current className:', button.className);
    
    if (isFalse) {
        // Detection is currently marked as FALSE POSITIVE
        // Show GREEN button to mark as VALID
        button.classList.add('btn-outline-success');
        button.innerHTML = '<i class="fas fa-check-circle"></i> Mark as Valid Detection';
        console.log('✅ Applied GREEN button (detection is false positive) - classes:', button.classList.toString());
        
        // Force the styles directly as a fallback
        button.style.borderColor = '#28a745';
        button.style.color = '#28a745';
        button.style.backgroundColor = 'white';
        button.style.borderWidth = '2px';
        button.style.borderStyle = 'solid';
        
    } else {
        // Detection is currently marked as VALID
        // Show ORANGE button to mark as FALSE POSITIVE
        button.classList.add('btn-outline-warning');
        button.innerHTML = '<i class="fas fa-flag"></i> Mark as False Positive';
        console.log('🚨 Applied ORANGE button (detection is valid) - classes:', button.classList.toString());
        
        // Force the styles directly as a fallback
        button.style.borderColor = '#ffc107';
        button.style.color = '#ffc107';
        button.style.backgroundColor = 'white';
        button.style.borderWidth = '2px';
        button.style.borderStyle = 'solid';
    }
    
    // Force a style recalculation
    button.offsetHeight;
    console.log('🎨 Final button state - classes:', button.classList.toString());
    console.log('🎨 Final button innerHTML:', button.innerHTML);
    console.log('🎨 Final computed styles:', {
        borderColor: getComputedStyle(button).borderColor,
        color: getComputedStyle(button).color,
        backgroundColor: getComputedStyle(button).backgroundColor
    });
}

// Handle resize
window.addEventListener('resize', function() {
    if (detectionMap) {
        setTimeout(function() {
            detectionMap.invalidateSize();
        }, 100);
    }
});

// Debug helper
window.debugDetectionMap = function() {
    console.log('=== DETECTION MAP DEBUG INFO ===');
    console.log('Map object:', detectionMap);
    console.log('Container:', document.getElementById('detection-map'));
    console.log('Leaflet:', typeof L !== 'undefined' ? 'Loaded' : 'Not loaded');
    console.log('Data:', { boundariesData, camerasData, detectionCamera, mapCenter });
};

console.log('Detection map script loaded. Call debugDetectionMap() in console for debug info.');
</script>

{% csrf_token %}
<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
</script>
{% endblock %}