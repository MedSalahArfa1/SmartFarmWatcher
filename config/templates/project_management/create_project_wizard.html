{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Farm Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #45a049;
            --secondary-color: #667eea;
            --accent-color: #764ba2;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #17a2b8;
        }
        
         body {
            background: url('{% static "img/farm-bg.jpg" %}') no-repeat center center fixed;
            background-size: cover;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('{% static "img/farm-bg.jpg" %}') no-repeat center center fixed;
            background-size: cover;
            filter: blur(3px);
            z-index: -2;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
        } 
        .main-container {
            padding: 30px 0;
            min-height: calc(100vh - 76px);
        }
        
        .creation-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .creation-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .creation-header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }
        
        .creation-header p {
            margin: 10px 0 0;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .step-indicator {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .step-progress {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        
        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
        }
        
        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .step-circle.completed {
            background: var(--success-color);
            color: white;
        }
        
        .step-circle.active {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }
        
        .step-circle.pending {
            background: #e9ecef;
            color: #6c757d;
        }
        
        .step-title {
            font-size: 12px;
            font-weight: 500;
            color: #6c757d;
        }
        
        .step-line {
            height: 2px;
            width: 80px;
            background: #e9ecef;
            margin: 0 10px;
            margin-top: -30px;
        }
        
        .step-line.completed {
            background: var(--success-color);
        }
        
        .form-content {
            padding: 40px;
        }
        
        .form-section {
            display: none;
        }
        
        .form-section.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-control {
            border-radius: 8px;
            border: 1px solid #ddd;
            padding: 12px 15px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 500;
        }
        
        /* Map Styles */
        #map, #camera-map {
            height: 500px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            margin: 20px 0;
        }
        
        .map-instructions {
            background: #e8f5e8;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .map-instructions i {
            color: var(--primary-color);
            margin-right: 10px;
        }
        
        /* Camera Lists */
        .item-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .item-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .item-details {
            font-size: 12px;
            color: #6c757d;
            margin: 5px 0 0;
        }
        
        .item-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* Modal Styles */
        .modal-content {
            border-radius: 12px;
            border: none;
        }
        
        .modal-header {
            background: var(--primary-color);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-header .btn-close {
            filter: invert(1);
        }
        
        /* Summary Styles */
        .summary-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .summary-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .summary-label {
            font-weight: 500;
            color: #6c757d;
        }
        
        .summary-value {
            color: #2c3e50;
        }
        
        .alert {
            border-radius: 8px;
            border: none;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .outside-boundary {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .inside-boundary {
            background-color: #d1edff;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        @media (max-width: 768px) {
            .creation-header h1 {
                font-size: 2rem;
            }
            
            .form-content {
                padding: 20px;
            }
            
            .step-progress {
                gap: 10px;
            }
            
            .step-circle {
                width: 50px;
                height: 50px;
                font-size: 16px;
            }
            
            .step-line {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <div class="main-container">
        <div class="container">
            <div class="creation-card">
                <!-- Header -->
                <div class="creation-header">
                    <h1><i class="fas fa-plus-circle"></i> Create New Farm Project</h1>
                    <p>Set up your farm monitoring system in 4 easy steps</p>
                </div>

                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step-progress">
                        <div class="step-item">
                            <div class="step-circle {% if step >= 1 %}{% if step > 1 %}completed{% else %}active{% endif %}{% else %}pending{% endif %}">
                                {% if step > 1 %}<i class="fas fa-check"></i>{% else %}1{% endif %}
                            </div>
                            <div class="step-title">General Info</div>
                        </div>
                        <div class="step-line {% if step > 1 %}completed{% endif %}"></div>
                        <div class="step-item">
                            <div class="step-circle {% if step >= 2 %}{% if step > 2 %}completed{% else %}active{% endif %}{% else %}pending{% endif %}">
                                {% if step > 2 %}<i class="fas fa-check"></i>{% else %}2{% endif %}
                            </div>
                            <div class="step-title">Farm Boundary</div>
                        </div>
                        <div class="step-line {% if step > 2 %}completed{% endif %}"></div>
                        <div class="step-item">
                            <div class="step-circle {% if step >= 3 %}{% if step > 3 %}completed{% else %}active{% endif %}{% else %}pending{% endif %}">
                                {% if step > 3 %}<i class="fas fa-check"></i>{% else %}3{% endif %}
                            </div>
                            <div class="step-title">Camera Locations</div>
                        </div>
                        <div class="step-line {% if step > 3 %}completed{% endif %}"></div>
                        <div class="step-item">
                            <div class="step-circle {% if step >= 4 %}active{% else %}pending{% endif %}">
                                4
                            </div>
                            <div class="step-title">Finalize</div>
                        </div>
                    </div>
                </div>

                <!-- Form Content -->
                <div class="form-content">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}

                    <!-- Step 1: General Information -->
                    <div class="form-section {% if step == 1 %}active{% endif %}" id="step1">
                        <h4 class="mb-4" style="color: var(--primary-color);"><i class="fas fa-info-circle"></i> General Project Information</h4>
                        
                        <form method="post" id="project-creation-form" action="{% url 'project_management:create_project_wizard' %}">
    {% csrf_token %}
    <input type="hidden" name="current_step" value="1">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Project Name *</label>
                                        {{ form.name }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">City/Location *</label>
                                        {{ form.location_city }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Description/Notes</label>
                                {{ form.description }}
                            </div>
                            
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Contact Person</label>
                                        {{ form.contact_person }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">Contact Phone</label>
                                        {{ form.contact_phone }}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="navigation-buttons">
        <div></div>
        <button type="button" class="btn btn-primary" onclick="proceedToStep2()">
            Next: Draw Farm Boundary <i class="fas fa-arrow-right"></i>
        </button>
    </div>
                        </form>
                    </div>

                    <!-- Step 2: Farm Boundary Mapping -->
                    <div class="form-section {% if step == 2 %}active{% endif %}" id="step2">
    <h4 class="mb-4" style="color: var(--primary-color);"><i class="fas fa-map"></i> Draw Your Farm Boundary</h4>
    
    <div class="map-instructions">
        <i class="fas fa-info-circle"></i>
        <strong>Instructions:</strong> Use the polygon tool to draw the boundary of your farm on the satellite map. 
        Click on the polygon tool, then click on the map to create points around your farm perimeter.
    </div>
    
    <!-- Hidden inputs to store boundary data -->
    <input type="hidden" name="farm_boundaries_data" id="farm_boundaries_data">
    
    <div id="map"></div>
    
    <div class="navigation-buttons">
        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
            <i class="fas fa-arrow-left"></i> Previous
        </button>
        <button type="button" class="btn btn-primary" id="step2-submit" onclick="proceedToStep3()" disabled>
            Next: Add Camera Locations <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

                    <!-- Step 3: Camera Locations -->
<div class="form-section {% if step == 3 %}active{% endif %}" id="step3">
    <h4 class="mb-4" style="color: var(--primary-color);"><i class="fas fa-video"></i> Add Camera Locations</h4>
    
    <div class="map-instructions">
        <i class="fas fa-info-circle"></i>
        <strong>Instructions:</strong> 
        <ul class="mb-0 mt-2">
            <li>Click anywhere on the map to place a camera</li>
            <li><strong>Camera Colors:</strong>
                <span class="badge" style="background-color: #2196F3; color: white;">Blue = Inside Farm</span>
                <span class="badge" style="background-color: #ff9800; color: white;">Orange = Outside Farm</span>
                <span class="badge" style="background-color: #ff6b6b; color: white;">Red = Selected</span>
            </li>
        </ul>
    </div>
    
    <!-- Hidden inputs to store camera data -->
    <input type="hidden" name="cameras_data" id="cameras_data">
    
    <div id="camera-map"></div>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-video"></i> Cameras (<span id="camera-count">0</span>)</h5>
            </div>
            
            <div class="item-list" id="cameras-list">
                <div class="text-center text-muted py-4" id="no-cameras">
                    <i class="fas fa-video fa-2x mb-2"></i>
                    <p>No cameras added yet. Click on the map to place cameras, then add their details.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="navigation-buttons">
        <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
            <i class="fas fa-arrow-left"></i> Previous
        </button>
        <button type="button" class="btn btn-primary" onclick="proceedToStep4()">
            Next: Finalize Project <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

                    <!-- Step 4: Finalize Project -->
                    <div class="form-section {% if step == 4 %}active{% endif %}" id="step4">
    <h4 class="mb-4" style="color: var(--primary-color);"><i class="fas fa-check-circle"></i> Finalize Your Project</h4>
    
    <!-- Project Summary -->
    <div class="summary-section">
        <h5 class="summary-title">Project Summary</h5>
        <div class="summary-item">
            <span class="summary-label">Project Name:</span>
            <span class="summary-value" id="summary-name">-</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Location:</span>
            <span class="summary-value" id="summary-location">-</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Farm Boundaries:</span>
            <span class="summary-value" id="summary-boundaries">0</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Total Cameras:</span>
            <span class="summary-value" id="summary-cameras">0</span>
        </div>
    </div>
        
    <div class="navigation-buttons">
        <button type="button" class="btn btn-secondary" onclick="goToStep(3)">
            <i class="fas fa-arrow-left"></i> Previous
        </button>
        <button type="button" class="btn btn-primary btn-lg" onclick="createProject()">
            <i class="fas fa-rocket"></i> Create Project
        </button>
    </div>
</div>

<!-- Camera Modal -->
<div class="modal fade" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-video"></i> Add Camera Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    First select a camera location on the map above, then fill in the camera details below.
                </div>
                
                <form id="camera-form">
                    <input type="hidden" name="latitude" id="camera-lat">
                    <input type="hidden" name="longitude" id="camera-lng">
                    <input type="hidden" name="farm_boundary_temp_id" id="camera-boundary-id">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Camera Type *</label>
                                <select class="form-control" name="camera_type" id="camera-type" required>
                                    <option value="ip">IP Camera</option>
                                    <option value="cellular">Cellular Camera</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- IP Camera Fields -->
                    <div id="ip-fields" class="connection-settings">
                        <h6><i class="fas fa-network-wired"></i> IP Camera Settings</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">IP Address</label>
                                    <input type="text" class="form-control" name="ip_address" placeholder="192.168.1.100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Port</label>
                                    <input type="number" class="form-control" name="port" placeholder="554" min="1" max="65535">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cellular Camera Fields -->
                    <div id="cellular-fields" class="connection-settings" style="display: none;">
                        <h6><i class="fas fa-signal"></i> Cellular Camera Settings</h6>
                        <div class="form-group">
                            <label class="form-label">Cellular Identifier</label>
                            <input type="text" class="form-control" name="cellular_identifier" placeholder="CAM001234567890">
                        </div>
                    </div>
                    
                    <div class="form-group mt-3">
                        <label class="form-label">Description/Notes</label>
                        <textarea class="form-control" name="description" rows="2" placeholder="Camera description..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-camera">
                    <i class="fas fa-save"></i> Save Camera
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
    let map, cameraMap;
    let drawnItems, cameraMarkers = [];
    let farmBoundaries = [];
    let cameras = [];
    let selectedCameraMarker = null;
    let currentStep = {{ step|default:1 }};
    let projectData = {};
    let cameraMarkersMap = new Map(); // Track camera-marker relationships
    
    document.addEventListener('DOMContentLoaded', function() {
        initializeCurrentStep();
        setupEventListeners();
    });
    
    function initializeCurrentStep() {
        if (currentStep === 2) {
            setTimeout(() => initializeMainMap(), 100);
        } else if (currentStep === 3) {
            setTimeout(() => initializeCameraMap(), 100);
        }
    }
    
    function initializeMainMap() {
        map = L.map('map').setView([36.8065, 10.1815], 13);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        }).addTo(map);
        
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        
        const drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems,
                remove: true
            },
            draw: {
                polygon: {
                    allowIntersection: false,
                    showArea: true
                },
                polyline: false,
                circle: false,
                rectangle: false,
                marker: false,
                circlemarker: false
            }
        });
        map.addControl(drawControl);
        
        map.on(L.Draw.Event.CREATED, function(e) {
            const layer = e.layer;
            drawnItems.clearLayers();
            drawnItems.addLayer(layer);
            
            // Get the GeoJSON with proper coordinate structure
            const geoJSON = layer.toGeoJSON();
            
            // Ensure we have a valid polygon geometry
            if (geoJSON.geometry && geoJSON.geometry.type === 'Polygon') {
                // Store the boundary data with proper structure
                farmBoundaries = [{
                    temp_id: 1,
                    boundary: geoJSON.geometry, // Store just the geometry part, not the full GeoJSON
                    description: ''
                }];
                
                updateBoundaryData();
                document.getElementById('step2-submit').disabled = false;
            } else {
                showAlert('danger', 'Invalid boundary geometry. Please draw a proper polygon.');
                document.getElementById('step2-submit').disabled = true;
            }
        });
        
        map.on(L.Draw.Event.DELETED, function() {
            farmBoundaries = [];
            updateBoundaryData();
            document.getElementById('step2-submit').disabled = true;
        });
        
        setTimeout(() => map.invalidateSize(), 100);
    }
    
    function initializeCameraMap() {
        cameraMap = L.map('camera-map').setView([36.8065, 10.1815], 15);
        
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Esri'
        }).addTo(cameraMap);
        
        cameraMarkers = new L.FeatureGroup();
        cameraMap.addLayer(cameraMarkers);
        
        // Load farm boundary if exists
        if (farmBoundaries.length > 0) {
            try {
                const boundaryGeometry = farmBoundaries[0].boundary;
                
                // Create a full GeoJSON object for Leaflet
                const boundaryGeoJSON = {
                    type: "Feature",
                    geometry: boundaryGeometry,
                    properties: {}
                };
                
                const boundaryLayer = L.geoJSON(boundaryGeoJSON, {
                    style: {
                        color: '#4CAF50',
                        weight: 3,
                        fillOpacity: 0.1,
                        dashArray: '5, 5'
                    }
                }).addTo(cameraMap);
                
                cameraMap.fitBounds(boundaryLayer.getBounds(), { padding: [20, 20] });
                window.farmBoundaryLayer = boundaryLayer;
                
            } catch (e) {
                console.error('Error loading farm boundary:', e);
            }
        }
        
        cameraMap.on('click', function(e) {
            
            const marker = L.marker(e.latlng, {
                icon: getCameraIcon(true),
                draggable: true
            });
            
            marker.addTo(cameraMarkers);
            selectedCameraMarker = marker;
            
            // Set form values
            document.getElementById('camera-lat').value = e.latlng.lat;
            document.getElementById('camera-lng').value = e.latlng.lng;
            document.getElementById('camera-boundary-id').value = 1; // First boundary
            
            
            const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
            modal.show();
            
            marker.on('dragend', function() {
                const pos = marker.getLatLng();
                document.getElementById('camera-lat').value = pos.lat;
                document.getElementById('camera-lng').value = pos.lng;
            });
        });
        
        setTimeout(() => cameraMap.invalidateSize(), 100);
    }
    
    function getCameraIcon(selected = false) {
        const backgroundColor = selected ? '#ff6b6b' : '#2196F3';
        return L.divIcon({
            className: 'camera-marker',
            html: `<div style="
                background: ${backgroundColor};
                width: 20px;
                height: 20px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 10px;
            "><i class="fas fa-video"></i></div>`,
            iconSize: [26, 26],
            iconAnchor: [13, 13]
        });
    }
    
    function setupEventListeners() {
        // Camera type change
        document.getElementById('camera-type')?.addEventListener('change', function() {
            const isIp = this.value === 'ip';
            document.getElementById('ip-fields').style.display = isIp ? 'block' : 'none';
            document.getElementById('cellular-fields').style.display = isIp ? 'none' : 'block';
        });
        
        // Save camera
        document.getElementById('save-camera')?.addEventListener('click', saveCameraData);
    }
    
    // Navigation functions
    function proceedToStep2() {
        if (validateStep1()) {
            saveProjectData();
            goToStep(2);
        }
    }
    
    function proceedToStep3() {
        validateBoundaryData().then(valid => {
            if (valid) goToStep(3);
        });
    }
    
    function proceedToStep4() {
        validateCameraData().then(valid => {
            if (valid) {
                updateSummary();
                goToStep(4);
            }
        });
    }
    
    function goToStep(step) {
        // Hide all steps
        document.querySelectorAll('.form-section').forEach(section => {
            section.classList.remove('active');
        });
        
        // Show target step
        document.getElementById(`step${step}`).classList.add('active');
        currentStep = step;
        
        // Update step indicators
        updateStepIndicators(step);
        
        // Initialize maps if needed
        if (step === 2) {
            setTimeout(() => initializeMainMap(), 100);
        } else if (step === 3) {
            setTimeout(() => initializeCameraMap(), 100);
        }
    }
    
    function updateStepIndicators(activeStep) {
        for (let i = 1; i <= 4; i++) {
            const circle = document.querySelector(`.step-item:nth-child(${i * 2 - 1}) .step-circle`);
            const line = document.querySelector(`.step-line:nth-child(${i * 2})`);
            
            if (i < activeStep) {
                circle.className = 'step-circle completed';
                circle.innerHTML = '<i class="fas fa-check"></i>';
                if (line) line.className = 'step-line completed';
            } else if (i === activeStep) {
                circle.className = 'step-circle active';
                circle.innerHTML = i;
                if (line) line.className = 'step-line';
            } else {
                circle.className = 'step-circle pending';
                circle.innerHTML = i;
                if (line) line.className = 'step-line';
            }
        }
    }
    
    // Validation functions
    function validateStep1() {
        const name = document.querySelector('#id_name').value.trim();
        const location = document.querySelector('#id_location_city').value.trim();
        
        if (!name || !location) {
            showAlert('warning', 'Please fill in the required fields.');
            return false;
        }
        return true;
    }
    
    async function validateBoundaryData() {
        if (farmBoundaries.length === 0) {
            showAlert('warning', 'Please draw at least one farm boundary.');
            return false;
        }
        
        try {
            const response = await fetch('{% url "project_management:validate_boundary_step" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `farm_boundaries_data=${encodeURIComponent(JSON.stringify(farmBoundaries))}`
            });
            
            const data = await response.json();
            
            if (!data.valid) {
                showAlert('danger', data.message);
                return false;
            }
            return true;
        } catch (error) {
            console.error('Validation error:', error);
            showAlert('danger', 'Validation error occurred.');
            return false;
        }
    }
    
    async function validateCameraData() {
        if (cameras.length === 0) {
            showAlert('warning', 'Please add at least one camera.');
            return false;
        }
        
        try {
            const response = await fetch('{% url "project_management:validate_camera_step" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `farm_boundaries_data=${encodeURIComponent(JSON.stringify(farmBoundaries))}&cameras_data=${encodeURIComponent(JSON.stringify(cameras))}`
            });
            
            const data = await response.json();
            if (!data.valid) {
                showAlert('danger', data.message);
                return false;
            }
            return true;
        } catch (error) {
            showAlert('danger', 'Validation error occurred.');
            return false;
        }
    }
    
    // Data management functions
    function saveProjectData() {
        projectData = {
            name: document.querySelector('#id_name').value,
            description: document.querySelector('#id_description').value,
            location_city: document.querySelector('#id_location_city').value,
            contact_person: document.querySelector('#id_contact_person').value,
            contact_phone: document.querySelector('#id_contact_phone').value
        };
    }
    
    function updateBoundaryData() {
        document.getElementById('farm_boundaries_data').value = JSON.stringify(farmBoundaries);
    }
    
    function updateCameraData() {
        document.getElementById('cameras_data').value = JSON.stringify(cameras);
        document.getElementById('camera-count').textContent = cameras.length;
    }
    
    function validateCameraForm() {
        const form = document.getElementById('camera-form');
        const formData = new FormData(form);
        const cameraType = formData.get('camera_type');
        
        if (cameraType === 'ip') {
            const ipAddress = formData.get('ip_address');
            const port = formData.get('port');
            
            if (!ipAddress || !port) {
                showAlert('warning', 'IP address and port are required for IP cameras.');
                return false;
            }
            
            // Basic IP validation
            const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!ipRegex.test(ipAddress)) {
                showAlert('warning', 'Please enter a valid IP address.');
                return false;
            }
            
            const portNum = parseInt(port);
            if (portNum < 1 || portNum > 65535) {
                showAlert('warning', 'Port must be between 1 and 65535.');
                return false;
            }
        } else if (cameraType === 'cellular') {
            const cellularId = formData.get('cellular_identifier');
            if (!cellularId) {
                showAlert('warning', 'Cellular identifier is required for cellular cameras.');
                return false;
            }
        }
        
        return true;
    }
    
    function saveCameraData() {
        if (!validateCameraForm()) {
            return;
        }
        
        const form = document.getElementById('camera-form');
        const formData = new FormData(form);
        
        const camera = {
            temp_id: Date.now(),
            farm_boundary_temp_id: formData.get('farm_boundary_temp_id') || 1,
            camera_type: formData.get('camera_type'),
            description: formData.get('description') || '',
            ip_address: formData.get('ip_address') || null,
            port: formData.get('port') ? parseInt(formData.get('port')) : null,
            cellular_identifier: formData.get('cellular_identifier') || null,
            location: {
                lat: parseFloat(formData.get('latitude')),
                lng: parseFloat(formData.get('longitude'))
            }
        };
        
        // Validate required fields based on camera type
        if (camera.camera_type === 'ip') {
            if (!camera.ip_address || !camera.port) {
                showAlert('danger', 'IP address and port are required for IP cameras.');
                return;
            }
        } else if (camera.camera_type === 'cellular') {
            if (!camera.cellular_identifier) {
                showAlert('danger', 'Cellular identifier is required for cellular cameras.');
                return;
            }
        }
        
        // Validate location
        if (!camera.location.lat || !camera.location.lng || isNaN(camera.location.lat) || isNaN(camera.location.lng)) {
            showAlert('danger', 'Valid camera location is required.');
            return;
        }
        
        cameras.push(camera);
        updateCameraData();
        
        // Update marker and track it
        if (selectedCameraMarker) {
            selectedCameraMarker.setIcon(getCameraIcon(false));
            selectedCameraMarker.options.draggable = false;
            selectedCameraMarker.dragging.disable();
            
            // Store the relationship between camera and marker
            cameraMarkersMap.set(camera.temp_id, selectedCameraMarker);
            
            // Add popup with camera info
            selectedCameraMarker.bindPopup(`
                <div>
                    <strong>Camera #${camera.temp_id}</strong><br>
                    <small>Type: ${camera.camera_type}</small><br>
                    <small>${camera.camera_type === 'ip' ? `${camera.ip_address}:${camera.port}` : camera.cellular_identifier}</small>
                </div>
            `);
        }
        
        // Add to list
        addCameraToList(camera);
        
        // Close modal and reset
        bootstrap.Modal.getInstance(document.getElementById('cameraModal')).hide();
        form.reset();
        selectedCameraMarker = null;
        
        showAlert('success', 'Camera added successfully!');
    }
    
    function addCameraToList(camera) {
        const list = document.getElementById('cameras-list');
        const noCamera = document.getElementById('no-cameras');
        
        if (noCamera) noCamera.remove();
        
        // Create connection info based on camera type
        let connectionInfo = '';
        if (camera.camera_type === 'ip') {
            connectionInfo = `${camera.ip_address || ''}:${camera.port || ''}`;
        } else if (camera.camera_type === 'cellular') {
            connectionInfo = camera.cellular_identifier || '';
        }
        
        const cameraDiv = document.createElement('div');
        cameraDiv.className = 'item-card';
        cameraDiv.innerHTML = `
            <div class="item-info">
                <h6 class="item-name">Camera #${camera.temp_id}</h6>
                <p class="item-details">Type: ${camera.camera_type} | ${connectionInfo}</p>
            </div>
            <div class="item-actions">
                <button class="btn btn-danger btn-sm" onclick="deleteCamera(${camera.temp_id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        list.appendChild(cameraDiv);
    }
    
    function deleteCamera(tempId) {
        // Remove from cameras array
        cameras = cameras.filter(c => c.temp_id !== tempId);
        updateCameraData();
        
        // Remove marker from map
        const marker = cameraMarkersMap.get(tempId);
        if (marker && cameraMarkers) {
            cameraMarkers.removeLayer(marker);
            cameraMarkersMap.delete(tempId);
        }
        
        // Remove from UI
        const cameraCard = document.querySelector(`[onclick="deleteCamera(${tempId})"]`).closest('.item-card');
        if (cameraCard) {
            cameraCard.remove();
        }
        
        // Show no cameras message if empty
        if (cameras.length === 0) {
            document.getElementById('cameras-list').innerHTML = `
                <div class="text-center text-muted py-4" id="no-cameras">
                    <i class="fas fa-video fa-2x mb-2"></i>
                    <p>No cameras added yet. Click on the map to place cameras, then add their details.</p>
                </div>
            `;
        }
        
        showAlert('success', 'Camera deleted successfully!');
    }
    
    function updateSummary() {
        document.getElementById('summary-name').textContent = projectData.name || '-';
        document.getElementById('summary-location').textContent = projectData.location_city || '-';
        document.getElementById('summary-boundaries').textContent = farmBoundaries.length;
        document.getElementById('summary-cameras').textContent = cameras.length;
    }
    
    function openCameraModal() {
        if (!selectedCameraMarker) {
            showAlert('info', 'Please click on the map to place a camera first.');
            return;
        }
        const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
        modal.show();
    }
    
    function createProject() {
        
        if (cameras.length === 0) {
            showAlert('warning', 'Please add at least one camera before creating the project.');
            return;
        }
        
        // Prepare final form data
        const form = document.getElementById('project-creation-form');
        
        // Add all data as hidden inputs
        const hiddenInputs = `
            <input type="hidden" name="project_name" value="${escapeHtml(projectData.name || '')}">
            <input type="hidden" name="project_description" value="${escapeHtml(projectData.description || '')}">
            <input type="hidden" name="location_city" value="${escapeHtml(projectData.location_city || '')}">
            <input type="hidden" name="contact_person" value="${escapeHtml(projectData.contact_person || '')}">
            <input type="hidden" name="contact_phone" value="${escapeHtml(projectData.contact_phone || '')}">
            <input type="hidden" name="farm_boundaries_data" value='${JSON.stringify(farmBoundaries)}'>
            <input type="hidden" name="cameras_data" value='${JSON.stringify(cameras)}'>
        `;
        
        form.innerHTML = hiddenInputs + '<input type="hidden" name="csrfmiddlewaretoken" value="' + 
                        document.querySelector('[name=csrfmiddlewaretoken]').value + '">';
        
        form.submit();
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const formContent = document.querySelector('.form-content');
        formContent.insertBefore(alertDiv, formContent.firstChild);
        
        setTimeout(() => {
            const alert = bootstrap.Alert.getInstance(alertDiv);
            if (alert) alert.close();
        }, 5000);
    }
</script>
</body>
</html>