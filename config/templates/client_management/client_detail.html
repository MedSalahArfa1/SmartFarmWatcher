{% extends "dashboard/dashboard_base.html" %}

{% block title %}{{ client.get_full_name|default:client.username }} - Client Details{% endblock %}

{% block nav_clients %}active{% endblock %}

{% block extra_css %}
<style>
    .main-container {
        padding: 30px 0;
        min-height: calc(100vh - 76px);
    }
    
    .page-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }
    
    .page-header::before {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    
    .client-avatar-large {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 28px;
        font-weight: 600;
        margin-right: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .client-avatar-large img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }
    
    .info-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        margin-bottom: 25px;
        transition: all 0.3s ease;
    }
    
    .info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }
    
    .info-card h5 {
        color: var(--primary-color);
        margin-bottom: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .info-row {
        display: flex;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .info-row:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
        min-width: 120px;
        margin-right: 15px;
    }
    
    .info-value {
        color: #6c757d;
        flex: 1;
    }
    
    .status-badge {
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .status-active {
        background: #d4edda;
        color: #155724;
    }
    
    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }
    
    .project-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid var(--primary-color);
        transition: all 0.3s ease;
    }
    
    .project-card:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .project-name {
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 8px;
        text-decoration: none;
    }
    
    .project-name:hover {
        color: var(--primary-dark);
        text-decoration: underline;
    }
    
    .project-role {
        background: var(--primary-color);
        color: white;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 11px;
        font-weight: 500;
        text-transform: uppercase;
    }
    
    .project-meta {
        display: flex;
        gap: 15px;
        font-size: 13px;
        color: #6c757d;
        margin-top: 10px;
    }
    
    .project-meta span {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-item {
        background: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        border-top: 3px solid var(--primary-color);
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 5px;
    }
    
    .stat-label {
        font-size: 14px;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 12px;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .breadcrumb {
        background: none;
        padding: 0;
        margin-bottom: 20px;
    }
    
    .breadcrumb-item a {
        color: var(--primary-color);
        text-decoration: none;
    }
    
    .breadcrumb-item.active {
        color: #6c757d;
    }
    
    @media (max-width: 768px) {
        .client-header {
            flex-direction: column;
            text-align: center;
            gap: 20px;
        }
        
        .action-buttons {
            justify-content: center;
        }
        
        .info-row {
            flex-direction: column;
            gap: 5px;
        }
        
        .info-label {
            min-width: auto;
            margin-right: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex align-items-center justify-content-between flex-wrap client-header">
                <div class="d-flex align-items-center">
                    <div class="client-avatar-large">
                        {% if client.profile_picture %}
                            <img src="{{ client.profile_picture.url }}" alt="{{ client.get_full_name }}">
                        {% else %}
                            {{ client.first_name|first|default:client.username|first|upper }}{{ client.last_name|first|upper }}
                        {% endif %}
                    </div>
                    <div>
                        <h1 class="mb-2">{{ client.get_full_name|default:client.username }}</h1>
                        <p class="mb-1 opacity-75">
                            <i class="fas fa-envelope"></i> {{ client.email }}
                        </p>
                        <span class="status-badge {% if client.is_active %}status-active{% else %}status-inactive{% endif %}">
                            {% if client.is_active %}
                                <i class="fas fa-check"></i> Active Client
                            {% else %}
                                <i class="fas fa-ban"></i> Inactive Client
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">{{ client.project_roles.count }}</div>
                <div class="stat-label">Projects Assigned</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ client.date_joined|timesince }}</div>
                <div class="stat-label">Member Since</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">
                    {% if client.last_login %}
                        {{ client.last_login|timesince }} ago
                    {% else %}
                        Never
                    {% endif %}
                </div>
                <div class="stat-label">Last Login</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ client.project_roles.count }}</div>
                <div class="stat-label">Active Projects</div>
            </div>
        </div>

        <div class="row">
            <!-- Client Information -->
            <div class="col-lg-8 mb-4">
                <!-- Personal Information -->
                <div class="info-card">
                    <h5><i class="fas fa-user"></i> Personal Information</h5>
                    <div class="info-row">
                        <div class="info-label">Full Name:</div>
                        <div class="info-value">
                            {{ client.get_full_name|default:"Not specified" }}
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Username:</div>
                        <div class="info-value">{{ client.username }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Email:</div>
                        <div class="info-value">
                            <a href="mailto:{{ client.email }}">{{ client.email }}</a>
                        </div>
                    </div>
                    {% if client.phone %}
                    <div class="info-row">
                        <div class="info-label">Phone:</div>
                        <div class="info-value">
                            <a href="tel:{{ client.phone }}">{{ client.phone }}</a>
                        </div>
                    </div>
                    {% endif %}
                    <div class="info-row">
                        <div class="info-label">Account Status:</div>
                        <div class="info-value">
                            <span class="status-badge {% if client.is_active %}status-active{% else %}status-inactive{% endif %}">
                                {% if client.is_active %}Active{% else %}Inactive{% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Account Details -->
                <div class="info-card">
                    <h5><i class="fas fa-info-circle"></i> Account Details</h5>
                    <div class="info-row">
                        <div class="info-label">Date Joined:</div>
                        <div class="info-value">
                            {{ client.date_joined|date:"F d, Y" }} 
                            <small class="text-muted">({{ client.date_joined|timesince }} ago)</small>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Last Login:</div>
                        <div class="info-value">
                            {% if client.last_login %}
                                {{ client.last_login|date:"F d, Y H:i" }}
                                <small class="text-muted">({{ client.last_login|timesince }} ago)</small>
                            {% else %}
                                <span class="text-muted">Never logged in</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">User Type:</div>
                        <div class="info-value">
                            <span class="badge bg-secondary">{{ client.user_type|title|default:"Client" }}</span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Email Verified:</div>
                        <div class="info-value">
                            {% if client.email_verified %}
                                <span class="text-success"><i class="fas fa-check"></i> Verified</span>
                            {% else %}
                                <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Pending</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Project Access -->
                <div class="info-card">
                    
                    {% if client.project_roles.exists %}
                        {% for role in client.project_roles.select_related %}
                        <div class="project-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <a href="{% url 'project_management:project_detail' role.project.slug %}" 
                                       class="project-name">{{ role.project.name }}</a>
                                    <div class="project-meta">
                                        <span>
                                            <i class="fas fa-map-marker-alt"></i>
                                            {{ role.project.location_city|default:"Location not set" }}
                                        </span>
                                        <span>
                                            <i class="fas fa-calendar"></i>
                                            Added {{ role.created_at|date:"M d, Y" }}
                                        </span>
                                        <span>
                                            <i class="fas fa-{% if role.project.is_active %}check text-success{% else %}pause text-warning{% endif %}"></i>
                                            {% if role.project.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </div>
                                    {% if role.project.description %}
                                    <p class="text-muted mb-0 mt-2 small">{{ role.project.description|truncatechars:100 }}</p>
                                    {% endif %}
                                </div>
                                <div class="text-end">
                                    <span class="project-role">{{ role.get_role_display }}</span>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-danger remove-project" 
                                                data-role-id="{{ role.id }}"
                                                title="Remove access">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fas fa-project-diagram"></i>
                            <h6>No Project Access</h6>
                            <p>This client hasn't been assigned to any projects yet.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Handle status toggle
    document.querySelector('.toggle-status')?.addEventListener('click', function() {
        const clientId = this.dataset.clientId;
        const isActive = this.dataset.active === 'true';
        
        fetch(`/clients/${clientId}/toggle-status/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                              document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'active': !isActive
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showToast(data.message || 'Error updating client status', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error updating client status', 'error');
        });
    });

    // Handle project removal
    document.querySelectorAll('.remove-project').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Are you sure you want to remove this client from the project?')) {
                const roleId = this.dataset.roleId;
                
                fetch(`/clients/remove-project-role/${roleId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                      document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'),
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Project access removed successfully', 'success');
                        this.closest('.project-card').remove();
                    } else {
                        showToast('Error removing project access', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error removing project access', 'error');
                });
            }
        });
    });

    // Handle password reset
    document.querySelector('.reset-password')?.addEventListener('click', function() {
        if (confirm('Send password reset email to this client?')) {
            const clientId = this.dataset.clientId;
            
            fetch(`/clients/${clientId}/reset-password/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                  document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'),
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Password reset email sent successfully', 'success');
                } else {
                    showToast('Error sending password reset email', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error sending password reset email', 'error');
            });
        }
    });

    // Handle notes saving
    document.querySelector('.save-notes')?.addEventListener('click', function() {
        const clientId = this.dataset.clientId;
        const notes = document.getElementById('clientNotes').value;
        
        fetch(`/clients/${clientId}/save-notes/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                              document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                'notes': notes
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Notes saved successfully', 'success');
            } else {
                showToast('Error saving notes', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error saving notes', 'error');
        });
    });
</script>
{% endblock %}